bl_info = {
    "name": "Clothica Pattern Generator",
    "blender": (4, 2, 0),
    "category": "3D View",
    "author": "Miyashitaa",
    "version": (1, 0, 0),
    "description": "Generate basic garment pattern pieces (tops, skirts, sleeves, etc.) as editable mesh objects."
}

import bpy
import bmesh
from bpy.types import Operator, Panel
from bpy.props import StringProperty

# メッシュ形状の定義関数
def get_pattern_shape(pattern_type):
    shapes = {
        'TOPS': [(-0.2475, 0.185, 0),(-0.2237, 0.18653, 0), (-0.202035, 0.193, 0), (-0.1884, 0.19859, 0), (-0.176, 0.20883, 0),
                 (-0.15, 0.20045, 0), (-0.13499, 0.19562, 0), (-0.15, 0.105, 0), (-0.11701, 0.18982, 0), (-0.03578, 0.16364, 0),
                 (-0.057404, 0.10163, 0), (-0.062591, 0.055038, 0), (-0.0645, 0.035, 0), (-0.059229, 0.016968, 0), (-0.051355, 0.001874, 0), 
                 (-0.045018, -0.005729, 0), (-0.036695, -0.013234, 0),(-0.025898, -0.020157, 0),
                 (-0.0075, -0.025, 0), #ウエストダーツc頂点
                 (0.01001, -0.021848, 0),(0.022857, -0.016008, 0), (0.032592, -0.008092, 0), (0.039718, 0.001836, 0), (0.046103, 0.016426, 0),
                 (0.0495, 0.035, 0),
                 (0.0645, 0.02647, 0), #ウエストダーツb頂点
                 (0.155, -0.025, 0), (0.074536, 0.065862, 0), (0.076477, 0.07598, 0), (0.076507, 0.082521, 0), (0.073449, 0.12211, 0),
                 (0.066094, 0.1581, 0), (0.0585, 0.18402, 0),(0.0765, 0.19127, 0), (0.178, 0.232, 0), (0.18328, 0.20644, 0),
                 (0.18856, 0.19568, 0), (0.19864, 0.18279, 0), (0.2112, 0.17401, 0), (0.22114, 0.16906, 0), 
                 (0.2475, 0.162, 0), (0.2475, -0.025, 0), (0.2475, -0.185, 0), 
                 (0.162, -0.185, 0), (0.155, -0.185, 0),(0.148, -0.185, 0), #ウエストダーツa
                 (0.072, -0.185, 0), (0.0645, -0.185, 0), (0.057, -0.185, 0), #ウエストダーツb
                 (-0.002, -0.185, 0), (-0.0075, -0.185, 0), (-0.013, -0.185, 0), #ウエストダーツc
                 (-0.057, -0.185, 0), (-0.0745, -0.185, 0), (-0.092, -0.185, 0), #ウエストダーツd
                 (-0.146, -0.185, 0), (-0.155, -0.185, 0), (-0.164, -0.185, 0), #ウエストダーツe
                 (-0.241, -0.185, 0), (-0.2475, -0.185, 0), #ウエストダーツf
                 (-0.2475, -0.025, 0), 
                 (-0.2475, 0.105, 0), #ウエストダーツf頂点
                 (-0.155, -0.005, 0), #ウエストダーツe頂点
                 (-0.0745, 0.035, 0), #ウエストダーツd頂点
                 (0.155, -0.045, 0)   #ウエストダーツa頂点
                  ],

        'SLEEVE': [(-0.18666, -0.025, 0), #後ろ袖側わき
                   (-0.16706, -0.018651, 0), (-0.14425, -0.003023, 0), 
                   (-0.12917, 0.017781, 0), (-0.12302, 0.029305, 0), 
                   (-0.097081, 0.067631, 0), #後ろ折り線
                   (-0.092284, 0.074708, 0), (-0.074129, 0.097346, 0), 
                   (-0.053221, 0.11654, 0), (-0.031848, 0.12578, 0), 
                   (-0.0075, 0.12787, 0), #袖山線
                   (0.013307, 0.12257, 0), (0.03233, 0.11013, 0), (0.054802, 0.078753, 0), 
                   (0.065814, 0.058056, 0), #前袖折り線
                   (0.073705, 0.043209, 0), (0.077491, 0.036147, 0), (0.081339, 0.027514, 0), 
                   (0.094635, -0.000435, 0), (0.11248, -0.013758, 0), 
                   (0.13913, -0.025, 0), #前袖側わき
                   (-0.097081, -0.025, 0), #後ろ袖側わき
                   (-0.0075, -0.025, 0), #袖山線
                   (0.065814, -0.025, 0), #前袖側わき
                   (-0.18666, -0.1, 0), (-0.097081, -0.1, 0), #後ろ袖側下
                   (-0.0075, -0.1, 0), #袖山線
                   (0.065814, -0.1, 0), (0.13913, -0.1, 0) #前袖側下
                   ],
        'SKIRT': [(-0.2825, -0.1, 0), (-0.2825,-0.3, 0),
                  (-0.2425, 0.295, 0), (-0.2425, 0.12, 0), (-0.2425, 0.09, 0), (-0.2425, -0.1, 0), (-0.2425, -0.3, 0),
                  (-0.165, 0.30055, 0), (-0.165, 0.12, 0),
                  (-0.14979, 0.30121, 0),
                  (-0.14479, 0.17081, 0),
                  (-0.13458, 0.3025, 0),
                  (-0.10271, 0.3049, 0),
                  (-0.0875, 0.12, 0), (-0.0875, 0.30607, 0),
                  (-0.082867, 0.1865, 0),
                  (-0.072292, 0.30723, 0),
                  (-0.035719, 0.31, 0),
                  (-0.031666, 0.3, 0),
                  (-0.020833, 0.24, 0),
                  (-0.01, 0.12, 0), (-0.01, -0.3, 0),
                  (0.000833, 0.24, 0),
                  (0.011666, 0.3, 0),
                  (0.015719, 0.31, 0),
                  (0.074167, 0.3061, 0), (0.074167, 0.12, 0),
                  (0.086, 0.30538, 0), (0.086, 0.2075, 0),
                  (0.097833, 0.30462, 0),
                  (0.13966, 0.30186, 0),
                  (0.149, 0.30125, 0), (0.149, 0.2075, 0),
                  (0.15833, 0.12, 0),
                  (0.15839, 0.30062, 0),
                  (0.2425, 0.295, 0), (0.2425, 0.2075, 0), (0.2425, 0.12, 0), (0.2425, -0.3, 0)
                  ],
        'PANTS_STRAIGHT': [(-0.09731, 0.48172, 0), (-0.10098, 0.47, 0), 
                           (-0.11715, 0.39633, 0), (-0.12468, 0.32726, 0), 
                           (-0.12625, 0.29, 0), #HL
                           (-0.12625, 0.22, 0), #股ライン
                           (-0.11021, -0.055, 0), #KL
                           (-0.086012, -0.47, 0), (0.034702, -0.47, 0), (0.12625, -0.47, 0), (0.15599, -0.47, 0), #すそライン
                           (0.18014, -0.055, 0), #KL
                           (0.19395, 0.22008, 0), #股ライン
                           (0.15735, 0.23548, 0), (0.14905, 0.24312, 0), (0.13945, 0.25421, 0), 
                           (0.12625, 0.29, 0), #HL
                           (0.11165, 0.47, 0), (0.11149, 0.47153, 0), (0.034702, 0.47, 0), 
                           (-0.021889, 0.47423, 0), (-0.030519, 0.47487, 0), (-0.03908, 0.47581, 0), #ダーツ
                           (-0.067733, 0.47896, 0), (-0.077947, 0.47991, 0), #外周終わり
                           (-0.079819, 0.44991, 0), (-0.1013, 0.39218, 0), (-0.12344, 0.32693, 0), #ポケット
                           (-0.035769, 0.38497, 0), #ダーツ頂点
                           (0.034702, 0.29, 0), #HL
                           (0.034702, 0.22, 0), (0.12625, 0.22, 0), #股ライン
                           (0.034702, -0.055, 0), (0.12625, -0.055, 0), #KL
                           #前パンツおわり
                           (0.4474, 0.48904, 0), (0.44319, 0.47, 0), 
                           (0.41549, 0.31877, 0), #HL
                           (0.40088, 0.26697, 0), (0.39056, 0.25069, 0), (0.37552, 0.23913, 0), (0.35986, 0.22983, 0), 
                           (0.32848, 0.22, 0), #股ライン
                           (0.29596, 0.2117, 0), (0.26194, 0.21028, 0), 
                           (0.28268, 0.14745, 0), 
                           (0.32658, -0.055, 0), #KL
                           (0.35, -0.47, 0), (0.48633, -0.47, 0), (0.62239, -0.47, 0), #すそライン
                           (0.64664, -0.055, 0), #KL
                           (0.66076, 0.22, 0), #股ライン
                           (0.66436, 0.29 , 0), #HL
                           (0.66047, 0.37922, 0), (0.6472, 0.47, 0), (0.64615, 0.48203, 0), 
                           (0.56373, 0.48494, 0), (0.54677, 0.48554, 0), (0.52955, 0.48614, 0), #ダーツ
                           (0.54301, 0.38552, 0), #ダーツ頂点
                           (0.26194, 0.22, 0), (0.39739, 0.22, 0), (0.48633, 0.22, 0), #股ライン
                           (0.48633, -0.055, 0) #KL
                            ],
        'PANTS_SLIM': [(-0.097388, 0.47926, 0), (-0.1012, 0.46789, 0), 
                       (-0.11394, 0.42374, 0), (-0.12403, 0.34891, 0), 
                       (-0.12625, 0.28789, 0), #HL
                       (-0.12625, 0.21789, 0), #股ライン
                       (-0.093298, -0.056404, 0), #KL
                       (-0.060607, -0.47261, 0), (0.02425, -0.47261, 0), (0.10946, -0.47261, 0), #すそライン
                       (0.14225, -0.056404, 0), #KL
                       (0.17437, 0.21789, 0), #股ライン
                       (0.15646, 0.22717, 0), (0.14792, 0.23303, 0), (0.13964, 0.24513, 0), 
                       (0.12625, 0.28789, 0), #HL
                       (0.11105, 0.46789, 0), (0.11086, 0.47007, 0), (0.02425, 0.46789, 0), 
                       (-0.013288, 0.47134, 0), (-0.02544, 0.47246, 0), (-0.037591, 0.47358, 0), #ダーツ
                       (-0.03044, 0.38246, 0), #ダーツ頂点
                       (0.02425, 0.28789, 0), #HL
                       (0.02425, 0.21789, 0), (0.12625, 0.21789, 0), #股ライン
                       (0.02425, -0.056404, 0), #KL
                       #前パンツおわり
                       (0.3727, 0.50177, 0), (0.36191, 0.46789, 0), 
                       (0.32921, 0.34485, 0), #HL
                       (0.29756, 0.27859, 0), (0.28205, 0.25683, 0), (0.26263, 0.23452, 0), 
                       (0.23612, 0.21789, 0), #股ライン
                       (0.1867, 0.20453, 0), 
                       (0.25403, -0.056404, 0), #KL
                       (0.28761, -0.47261, 0), (0.38741, -0.47261, 0), (0.48775, -0.47261, 0), #すそライン
                       (0.5074, -0.056404, 0), #KL
                       (0.53791, 0.21789, 0), #股ライン
                       (0.54281, 0.28789, 0), #HL
                       (0.54298, 0.37331, 0), (0.5406, 0.46818, 0), 
                       (0.54027, 0.4805, 0), (0.52102, 0.48294, 0), 
                       (0.46572, 0.48996, 0), (0.45649, 0.49113, 0), (0.4471, 0.49232, 0), 
                       (0.444, 0.39183, 0), #ダーツ頂点
                       (0.1867, 0.21789, 0), (0.29546, 0.21789, 0), (0.38741, 0.21789, 0), 
                       (0.38741, -0.056404, 0)]
        }
    return shapes.get(pattern_type, [])

#面＋辺構成定義関数
def get_faces_and_edges(pattern_type):
    mapping = {
        'TOPS': {
           'faces': [ (0, 61, 60, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1),
                      (60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50, 18),
                      (18, 19, 20, 21, 22, 23, 24, 25, 26),(27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 26),
                      (18, 50, 49, 48, 47, 46, 45, 44, 43, 42, 41)],
            'edges': [(61, 58), 
                      (62, 55), (62, 56), (62, 57), 
                      (63, 52), (63, 53), (63, 54), 
                      (18, 49), (18, 50), (18, 51), 
                      (25, 46), (25, 47), (25, 48), 
                      (64, 43), (64, 44), (64, 45)]
        },
        'SLEEVE': {
            'faces': [(0, 1, 2, 3, 4, 5, 21), (5, 6, 7, 8, 9, 10, 22, 21), 
                      (10, 11, 12, 13, 14, 23, 22), (14, 15, 16, 17, 18, 19, 20, 23), 
                      (0, 24, 25, 21), (21, 25, 26, 22), 
                      (22, 26, 27, 23), (23, 27, 28, 20)
                      ],
            'edges': []
        },
        'SKIRT': {
            'faces': [(0, 1, 6, 5), (3, 4, 5, 6, 21, 20, 13, 8), (20, 21, 38, 37, 33, 26), 
                      (2, 3, 8, 13, 20, 19, 18, 17, 16, 15, 12, 11, 10, 7), 
                      (24, 23, 22, 20, 26, 33, 37, 36, 35, 34, 32, 30, 29, 28, 25)],
            'edges': [(7, 9), (9, 11), (9, 10),
                      (12, 14), (14, 16,), (14, 15),
                      (25, 27), (27, 29), (27, 28),
                      (30, 31), (31, 34), (31, 32)]
        },
        'PANTS_STRAIGHT': {
            'faces': [(0, 1, 2, 3, 4, 27, 26, 25, 23, 24), 
                      (23, 25, 26, 27, 4, 29, 19, 20, 28, 22), (19, 29, 16, 17, 18), 
                      (4, 5, 30, 29), (29, 30, 31, 16), (16, 15, 14, 13, 12, 31), 
                      (5, 6, 32, 30), (30, 32, 33 ,31), (31, 33, 11, 12), 
                      (6, 7, 8, 32), (32, 8, 9, 33), (33, 9, 10, 11), 
                      #前パンツ
                      (34, 35, 36, 51, 52, 53, 54, 55, 58, 57), 
                      (36, 37, 38, 39, 40, 41, 60), (36, 60, 61, 50, 51), 
                      (43, 44, 45, 62, 61, 60, 41, 42), (61, 62, 49, 50), 
                      (45, 46, 47, 62), (62, 47, 48, 49)
                      ],
            'edges': [(22, 21), (21, 20), (21, 28), 
                      (57, 56), (56, 55), (56, 58), 
                      (59, 43), (59, 41)
                      ]
        },
        'PANTS_SLIM': {
            'faces': [(0, 1, 2, 3, 4, 23, 18, 19, 22, 21), (18, 23, 15, 16, 17), 
                      (4, 5, 24, 23), (23, 24, 25, 15), (15, 25, 11, 12, 13, 14), 
                      (5, 6, 26, 24), (24, 26, 10, 11, 25), 
                      (6, 7, 8, 26), (26, 8, 9, 10), 
                      #前パンツ
                      (27, 28, 29, 41, 42, 43, 44, 45, 46, 49, 48), 
                      (29, 30, 31, 32, 33, 51), (29, 51, 52, 40, 41), 
                      (34, 35, 53, 52, 51, 33), (52, 53, 39, 40), 
                      (35, 36, 37, 53), (53, 37, 38, 39)],
            'edges': [(21, 20), (20, 19), (20, 22), 
                      (48, 47), (47, 46), (47, 48), 
                      (50, 33), (50, 34)]
        }
    }
    return mapping.get(pattern_type, {'faces': [], 'edges': []})


# メッシュ生成オペレータ
class CLOTHICA_OT_generate_pattern(Operator):
    bl_idname = "clothica.generate_pattern"
    bl_label = "Generate Pattern"

    pattern_type: StringProperty()

    def execute(self, context):
        verts = get_pattern_shape(self.pattern_type)
        mesh = bpy.data.meshes.new(f"{self.pattern_type}_Mesh")
        obj  = bpy.data.objects.new(f"{self.pattern_type}_Pattern", mesh)
        context.scene.collection.objects.link(obj)

        bm = bmesh.new()
        bm_verts = [bm.verts.new(v) for v in verts]

        structure = get_faces_and_edges(self.pattern_type)
        for f in structure['faces']:
            try: bm.faces.new([bm_verts[i] for i in f])
            except: continue
        for e in structure['edges']:
            try: bm.edges.new([bm_verts[e[0]], bm_verts[e[1]]])
            except: continue      

        bm.to_mesh(mesh)
        bm.free()

        return {'FINISHED'}

# パネルUI
class CLOTHICA_PT_pattern_panel(Panel):
    bl_label = "Clothica Pattern Generator"
    bl_idname = "CLOTHICA_PT_pattern_panel"
    bl_space_type = 'VIEW_3D'
    bl_region_type = 'UI'
    bl_category = 'Clothica'

    def draw(self, context):
        layout = self.layout
        layout.label(text="Select Pattern Type:")
        
        for label in ['TOPS', 'SLEEVE', 'SKIRT', 'PANTS_STRAIGHT', 'PANTS_SLIM']:
            op = layout.operator("clothica.generate_pattern", text=label.replace("_", " ").title())
            op.pattern_type = label


# 登録・解除
classes = [
    CLOTHICA_OT_generate_pattern,
    CLOTHICA_PT_pattern_panel,
]

def register():
    for cls in classes:
        bpy.utils.register_class(cls)

def unregister():
    for cls in reversed(classes):
        bpy.utils.unregister_class(cls)

if __name__ == "__main__":
    register()